import{c as ae,j as l,q as e,x as O,z as u,y as oe,P as N,B as _,A as re,S as ie,C as le}from"./index-nTJrk6Cr.js";import{C as ce,g as H,c as de,A as me,T as ue,f as ge}from"./fetchallaccounts-B1Uk_Fj6.js";import{d as he,C as xe,c as fe,b as pe,g as ke}from"./source-RH5lTv4m.js";import{u as be,g as ye}from"./hf-v0HQUZZC.js";import{I as we}from"./input-Co7IGjxm.js";import{T as je,f as ve}from"./TokenIcon-Caxk1t8g.js";import{W as Me}from"./wallet-BuNyXI7o.js";import{L as Ne}from"./loader-circle-DcjAOCym.js";import{u as Ae}from"./useAnchorWallet-C1uQcfNX.js";/**
 * @license lucide-react v0.516.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],Te=ae("external-link",Se),y=6,Ce=i=>{if(!i)return new u(0);try{const o=i.split("."),p=new u(o[0]||0);let h=new u(0);if(o[1]){const w=o[1].slice(0,y).padEnd(y,"0");h=new u(w)}const k=new u(10).pow(new u(y));return p.mul(k).add(h)}catch{return null}},Pe=i=>{if(i.isZero())return"";const o=new u(10).pow(new u(y)),p=i.div(o),h=i.mod(o);if(h.isZero())return p.toString();const k=h.toString().padStart(y,"0").replace(/0+$/,"");return`${p.toString()}.${k||"0"}`},Ie=()=>e.jsx("div",{className:"space-y-6",children:[...Array(2)].map((i,o)=>e.jsxs("div",{className:"bg-gray-900/50 border-gray-800 rounded-xl p-6 space-y-4 animate-pulse",children:[e.jsx("div",{className:"h-6 bg-gray-700 rounded w-1/2"}),e.jsx("div",{className:"h-12 bg-gray-700 rounded"}),e.jsx("div",{className:"h-10 bg-gray-700 rounded w-full"})]},o))}),q=({message:i,onDismiss:o})=>e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 text-red-300 px-4 py-3 rounded-lg mb-4 flex items-center justify-between",children:[e.jsx("span",{children:i}),e.jsx("button",{onClick:o,className:"text-red-300 hover:text-white focus:outline-none","aria-label":"Dismiss error",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]});function Ve(){var L,E,B;const i=Ae(),[o,p]=l.useState([]),[h,k]=l.useState(!0),[w,T]=l.useState({}),[j,C]=l.useState({}),[P,V]=l.useState(null),z=l.useCallback(()=>V(null),[]),F=l.useCallback(t=>{C(n=>({...n,[t]:{...n[t],error:null}}))},[]),[c,U]=l.useState({}),[I,W]=l.useState({}),x=l.useCallback((t,n)=>{C(r=>({...r,[t]:{...r[t],...n}}))},[]),Z=l.useCallback(t=>j[t]||{isLoading:!1,txSig:null,error:null},[j]),G=async t=>{if(!(i!=null&&i.publicKey))return;const n=ke(i);if(!n)return;const r=w[t.tokenMint];if(!r||r.isZero()){x(t.tokenMint,{error:"Please enter a valid amount"});return}x(t.tokenMint,{isLoading:!0,error:null,txSig:null});try{const a=i.publicKey,s=new N(t.tokenMint),d=new N(t.publicKey),f=await H(s,d,!0),m=n.provider.connection,g=await H(s,a);if(!await m.getAccountInfo(g)){x(t.tokenMint,{isLoading:!1,error:`Token account ${g.toString()} does not exist. Please ensure you have some tokens to deposit.`});return}const b=await m.getTokenAccountBalance(g);if(console.log("Token balance:",{mint:s.toString(),userTokenAccount:g.toString(),balance:b.value.uiAmount,decimals:b.value.decimals,requestedAmount:r.toString(),requestedUiAmount:Number(r)/Math.pow(10,b.value.decimals)}),new u(b.value.amount).lt(r)){x(t.tokenMint,{isLoading:!1,error:`Insufficient balance. You have ${b.value.uiAmount} tokens but trying to deposit ${Number(r)/Math.pow(10,b.value.decimals)}`});return}const[D]=N.findProgramAddressSync([_.from("deposit"),a.toBuffer(),s.toBuffer()],n.programId),[A]=N.findProgramAddressSync([_.from("user"),a.toBuffer(),s.toBuffer()],n.programId);if(console.log("Program addresses:",{depositPDA:D.toString(),userPDA:A.toString(),vaultATA:f.toString()}),!await m.getAccountInfo(g)){const S=de(a,g,a,s),M=new re().add(S),{blockhash:te,lastValidBlockHeight:se}=await m.getLatestBlockhash("finalized");M.recentBlockhash=te,M.lastValidBlockHeight=se,M.feePayer=i.publicKey;const ne=await i.signTransaction(M);await m.sendRawTransaction(ne.serialize())}const v=await n.methods.depositCollateral(r).accountsStrict({user:i.publicKey,tokenMint:s,userTokenAccount:g,userData:A,deposit:D,config:d,vault:f,tokenProgram:ue,systemProgram:ie.programId,associatedTokenProgram:me}).transaction(),{blockhash:K,lastValidBlockHeight:R}=await m.getLatestBlockhash("finalized");v.recentBlockhash=K,v.lastValidBlockHeight=R,v.feePayer=i.publicKey;const X=await i.signTransaction(v),$=await m.sendRawTransaction(X.serialize());await m.confirmTransaction({blockhash:K,lastValidBlockHeight:R,signature:$}),x(t.tokenMint,{isLoading:!1,txSig:$}),T(S=>({...S,[t.tokenMint]:new u(0)}));const ee=await be(a,s,n);await n.methods.temp(ee).accountsStrict({user:a,userData:A,tokenMint:s}).rpc()}catch(a){console.error("Transaction failed:",a);let s="An unknown error occurred.";a instanceof le?(a.logs||[]).some(f=>f.includes("insufficient funds"))?s="Transaction failed due to insufficient funds. Please check your token balance.":s="Transaction simulation failed. See console for details.":a instanceof Error&&(s=a.message),x(t.tokenMint,{isLoading:!1,error:s})}},Y=(t,n)=>{const r=Ce(n);r!==null&&T(a=>({...a,[t]:r})),x(t,{error:null})};l.useEffect(()=>{console.log("Configs changed, loading metadata for:",o.map(n=>{var r;return{mint:n.tokenMint,name:((r=c[n.tokenMint])==null?void 0:r.name)||"Not loaded"}}));const t=async()=>{const n={},r=o.filter(a=>!c[a.tokenMint]);console.log(`Fetching metadata for ${r.length} tokens:`,r.map(a=>a.tokenMint.slice(0,4)+"..."+a.tokenMint.slice(-4)));try{(await Promise.allSettled(r.map(s=>ve(s.tokenMint).then(d=>({tokenMint:s.tokenMint,metadata:d}))))).forEach(s=>{s.status==="fulfilled"&&s.value.metadata?(console.log(`Fetched metadata for ${s.value.tokenMint}:`,s.value.metadata),n[s.value.tokenMint]=s.value.metadata):s.status==="rejected"&&console.error("Error fetching token metadata:",s.reason)}),Object.keys(n).length>0?(console.log("Updating token metadata map with new entries"),U(s=>({...s,...n}))):console.log("No new token metadata to update")}catch(a){console.error("Error in token metadata loading batch:",a)}};o.length>0&&t()},[o,c]),l.useEffect(()=>{if(!i)return;(async()=>{k(!0);try{const n=await ge(i);p(n);const r=[...new Set(n.map(s=>s.tokenMint))],a={};for(const s of r)try{const d=await ye(s);a[s]=Number(d.toString())}catch(d){console.error(`Error fetching price for token ${s}:`,d),a[s]=0}W(a)}catch(n){console.error("Error loading configs:",n)}finally{k(!1)}})()},[i]);const J={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}};if(!i)return e.jsx("div",{className:"w-full bg-gray-950 text-white min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-gray-900 border-2 border-gray-800 rounded-full flex items-center justify-center mb-4",children:e.jsx(Me,{className:"h-8 w-8 text-gray-600"})}),e.jsx("h2",{className:"text-2xl font-bold mb-2 text-white",children:"Connect Wallet"}),e.jsx("p",{className:"text-gray-400",children:"Please connect your wallet to deposit collateral."})]})});const Q=o.length>0?{firstConfig:{mint:o[0].tokenMint,metadata:c[o[0].tokenMint],hasLogo:!!((L=c[o[0].tokenMint])!=null&&L.logoURI)},tokenMetadataCount:Object.keys(c).length}:{noConfigs:!0};return console.log("Render debug info:",Q),e.jsxs("div",{className:"w-full bg-gray-950 text-white min-h-screen",children:[e.jsx("div",{className:"fixed bottom-4 right-4 bg-black/80 p-3 rounded-lg text-xs z-50 max-w-xs",children:e.jsxs("div",{className:"font-mono",children:[e.jsxs("div",{children:["Tokens: ",o.length]}),e.jsxs("div",{children:["Metadata: ",Object.keys(c).length]}),o.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{children:["First token: ",o[0].tokenMint.slice(0,6),"...",o[0].tokenMint.slice(-4)]}),e.jsxs("div",{children:["Name: ",((E=c[o[0].tokenMint])==null?void 0:E.name)||"Loading..."]}),e.jsxs("div",{children:["Has logo: ",(B=c[o[0].tokenMint])!=null&&B.logoURI?"✅":"❌"]})]})]})}),e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 py-12",children:[e.jsxs(O.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"mb-12",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-white",children:"Deposit Collateral"}),e.jsx("p",{className:"text-lg text-gray-400 mt-2",children:"Select a token and deposit funds to use as collateral."})]}),P&&e.jsx("div",{className:"mb-6",children:e.jsx(q,{message:P,onDismiss:z})}),h?e.jsx(Ie,{}):o.length===0?e.jsx("div",{className:"text-center py-16",children:e.jsx("p",{className:"text-gray-400",children:"No token configurations found."})}):e.jsx(O.div,{className:"space-y-6",variants:J,initial:"hidden",animate:"visible",children:o.map(t=>{var s,d,f,m;const n=Z(t.tokenMint),r=w[t.tokenMint]||new u(0),a=Pe(r);return e.jsxs(he,{className:"bg-gray-900/50 border-gray-800 overflow-hidden",children:[e.jsx(xe,{children:e.jsxs(fe,{className:"text-xl text-white flex items-center gap-3",children:[e.jsxs("div",{className:"relative",style:{width:36,height:36},children:[e.jsx(je,{mintAddress:t.tokenMint,size:36,className:"border border-purple-500/30"}),!((s=c[t.tokenMint])!=null&&s.logoURI)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-xs font-bold text-white",children:t.tokenMint.slice(0,2).toUpperCase()})]}),e.jsxs("span",{className:"break-all ml-3",children:[((d=c[t.tokenMint])==null?void 0:d.name)||"Token",e.jsxs("span",{className:"text-sm text-gray-400 block mt-1",children:[((f=c[t.tokenMint])==null?void 0:f.symbol)||"TOKEN",I[t.tokenMint]>0&&e.jsxs("span",{className:"ml-2 text-green-400",children:["($",(I[t.tokenMint]/1e4).toFixed(4),")"]})]})]})]})}),e.jsxs(pe,{className:"space-y-4",children:[e.jsx("div",{className:"relative",children:e.jsx(we,{type:"number",step:"any",min:"0",value:a,placeholder:"0.00",onChange:g=>Y(t.tokenMint,g.target.value),disabled:n.isLoading,className:"bg-gray-800 border-gray-700 h-12 text-lg"})}),e.jsx(oe,{className:"w-full h-11 text-base bg-purple-600 hover:bg-purple-700 text-white",onClick:()=>G(t),disabled:n.isLoading||r.isZero(),children:n.isLoading?e.jsx(Ne,{className:"h-5 w-5 animate-spin"}):"Deposit Collateral"}),n.txSig&&e.jsxs("div",{className:"bg-green-900/30 text-green-400 text-sm p-3 border border-green-800 rounded-md flex items-start gap-2",children:[e.jsx(ce,{className:"h-4 w-4 mt-0.5 flex-shrink-0"}),e.jsx("div",{className:"flex-grow min-w-0",children:e.jsxs("a",{href:`https://explorer.solana.com/tx/${n.txSig}?cluster=devnet`,target:"_blank",rel:"noreferrer",className:"text-green-400 hover:text-green-300 underline flex items-center",children:["View Transaction ",e.jsx(Te,{className:"h-3 w-3 ml-1"})]})})]}),e.jsx("div",{className:"mt-4",children:((m=j[t.tokenMint])==null?void 0:m.error)&&e.jsx("div",{className:"mb-4",children:e.jsx(q,{message:j[t.tokenMint].error,onDismiss:()=>F(t.tokenMint)})})})]})]},t.publicKey)})})]})]})}export{Ve as default};
