import{c as te,j as l,q as e,x as $,z as m,y as ne,P as N,B as O,A as ae,S as se,C as oe}from"./index-B7vkYCve.js";import{C as re,g as _,c as ie,A as le,T as ce,f as de}from"./fetchallaccounts-CPPSWCQ-.js";import{d as ue,C as me,c as ge,b as he,g as xe}from"./source-B7nfvOd2.js";import{u as fe,g as pe}from"./hf-Bac-RGgZ.js";import{I as ke}from"./input-BzVyemLo.js";import{T as be,f as ye}from"./TokenIcon-LF4L0gzO.js";import{W as we}from"./wallet-BDKyIvfy.js";import{L as je}from"./loader-circle-C00ltvLf.js";import{u as ve}from"./useAnchorWallet-BHa7C_ie.js";/**
 * @license lucide-react v0.516.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],Ne=te("external-link",Me),y=6,Ae=i=>{if(!i)return new m(0);try{const o=i.split("."),p=new m(o[0]||0);let h=new m(0);if(o[1]){const w=o[1].slice(0,y).padEnd(y,"0");h=new m(w)}const k=new m(10).pow(new m(y));return p.mul(k).add(h)}catch{return null}},Se=i=>{if(i.isZero())return"";const o=new m(10).pow(new m(y)),p=i.div(o),h=i.mod(o);if(h.isZero())return p.toString();const k=h.toString().padStart(y,"0").replace(/0+$/,"");return`${p.toString()}.${k||"0"}`},Te=()=>e.jsx("div",{className:"space-y-6",children:[...Array(2)].map((i,o)=>e.jsxs("div",{className:"bg-gray-900/50 border-gray-800 rounded-xl p-6 space-y-4 animate-pulse",children:[e.jsx("div",{className:"h-6 bg-gray-700 rounded w-1/2"}),e.jsx("div",{className:"h-12 bg-gray-700 rounded"}),e.jsx("div",{className:"h-10 bg-gray-700 rounded w-full"})]},o))}),Ce=({message:i,onDismiss:o})=>e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 text-red-300 px-4 py-3 rounded-lg mb-4 flex items-center justify-between",children:[e.jsx("span",{children:i}),e.jsx("button",{onClick:o,className:"text-red-300 hover:text-white focus:outline-none","aria-label":"Dismiss error",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]});function qe(){var I,L,B;const i=ve(),[o,p]=l.useState([]),[h,k]=l.useState(!0),[w,T]=l.useState({}),[j,C]=l.useState({}),[Pe,H]=l.useState(null);l.useCallback(()=>H(null),[]);const q=l.useCallback(t=>{C(a=>({...a,[t]:{...a[t],error:null}}))},[]),[c,V]=l.useState({}),[P,z]=l.useState({}),x=l.useCallback((t,a)=>{C(r=>({...r,[t]:{...r[t],...a}}))},[]),F=l.useCallback(t=>j[t]||{isLoading:!1,txSig:null,error:null},[j]),U=async t=>{if(!(i!=null&&i.publicKey))return;const a=xe(i);if(!a)return;const r=w[t.tokenMint];if(!r||r.isZero()){x(t.tokenMint,{error:"Please enter a valid amount"});return}x(t.tokenMint,{isLoading:!0,error:null,txSig:null});try{const s=i.publicKey,n=new N(t.tokenMint),d=new N(t.publicKey),f=await _(n,d,!0),u=a.provider.connection,g=await _(n,s);if(!await u.getAccountInfo(g)){x(t.tokenMint,{isLoading:!1,error:`Token account ${g.toString()} does not exist. Please ensure you have some tokens to deposit.`});return}const b=await u.getTokenAccountBalance(g);if(console.log("Token balance:",{mint:n.toString(),userTokenAccount:g.toString(),balance:b.value.uiAmount,decimals:b.value.decimals,requestedAmount:r.toString(),requestedUiAmount:Number(r)/Math.pow(10,b.value.decimals)}),new m(b.value.amount).lt(r)){x(t.tokenMint,{isLoading:!1,error:`Insufficient balance. You have ${b.value.uiAmount} tokens but trying to deposit ${Number(r)/Math.pow(10,b.value.decimals)}`});return}const[E]=N.findProgramAddressSync([O.from("deposit"),s.toBuffer(),n.toBuffer()],a.programId),[A]=N.findProgramAddressSync([O.from("user"),s.toBuffer(),n.toBuffer()],a.programId);if(console.log("Program addresses:",{depositPDA:E.toString(),userPDA:A.toString(),vaultATA:f.toString()}),!await u.getAccountInfo(g)){const S=ie(s,g,s,n),M=new ae().add(S),{blockhash:Q,lastValidBlockHeight:X}=await u.getLatestBlockhash("finalized");M.recentBlockhash=Q,M.lastValidBlockHeight=X,M.feePayer=i.publicKey;const ee=await i.signTransaction(M);await u.sendRawTransaction(ee.serialize())}const v=await a.methods.depositCollateral(r).accountsStrict({user:i.publicKey,tokenMint:n,userTokenAccount:g,userData:A,deposit:E,config:d,vault:f,tokenProgram:ce,systemProgram:se.programId,associatedTokenProgram:le}).transaction(),{blockhash:D,lastValidBlockHeight:K}=await u.getLatestBlockhash("finalized");v.recentBlockhash=D,v.lastValidBlockHeight=K,v.feePayer=i.publicKey;const Y=await i.signTransaction(v),R=await u.sendRawTransaction(Y.serialize());await u.confirmTransaction({blockhash:D,lastValidBlockHeight:K,signature:R}),x(t.tokenMint,{isLoading:!1,txSig:R}),T(S=>({...S,[t.tokenMint]:new m(0)}));const J=await fe(s,n,a);await a.methods.temp(J).accountsStrict({user:s,userData:A,tokenMint:n}).rpc()}catch(s){console.error("Transaction failed:",s);let n="An unknown error occurred.";s instanceof oe?(s.logs||[]).some(f=>f.includes("insufficient funds"))?n="Transaction failed due to insufficient funds. Please check your token balance.":n="Transaction simulation failed. See console for details.":s instanceof Error&&(n=s.message),x(t.tokenMint,{isLoading:!1,error:n})}},W=(t,a)=>{const r=Ae(a);r!==null&&T(s=>({...s,[t]:r})),x(t,{error:null})};l.useEffect(()=>{console.log("Configs changed, loading metadata for:",o.map(a=>{var r;return{mint:a.tokenMint,name:((r=c[a.tokenMint])==null?void 0:r.name)||"Not loaded"}}));const t=async()=>{const a={},r=o.filter(s=>!c[s.tokenMint]);console.log(`Fetching metadata for ${r.length} tokens:`,r.map(s=>s.tokenMint.slice(0,4)+"..."+s.tokenMint.slice(-4)));try{(await Promise.allSettled(r.map(n=>ye(n.tokenMint).then(d=>({tokenMint:n.tokenMint,metadata:d}))))).forEach(n=>{n.status==="fulfilled"&&n.value.metadata?(console.log(`Fetched metadata for ${n.value.tokenMint}:`,n.value.metadata),a[n.value.tokenMint]=n.value.metadata):n.status==="rejected"&&console.error("Error fetching token metadata:",n.reason)}),Object.keys(a).length>0?(console.log("Updating token metadata map with new entries"),V(n=>({...n,...a}))):console.log("No new token metadata to update")}catch(s){console.error("Error in token metadata loading batch:",s)}};o.length>0&&t()},[o,c]),l.useEffect(()=>{if(!i)return;(async()=>{k(!0);try{const a=await de(i);p(a);const r=[...new Set(a.map(n=>n.tokenMint))],s={};for(const n of r)try{const d=await pe(n);s[n]=Number(d.toString())}catch(d){console.error(`Error fetching price for token ${n}:`,d),s[n]=0}z(s)}catch(a){console.error("Error loading configs:",a)}finally{k(!1)}})()},[i]);const Z={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}};if(!i)return e.jsx("div",{className:"w-full bg-gray-950 text-white min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-gray-900 border-2 border-gray-800 rounded-full flex items-center justify-center mb-4",children:e.jsx(we,{className:"h-8 w-8 text-gray-600"})}),e.jsx("h2",{className:"text-2xl font-bold mb-2 text-white",children:"Connect Wallet"}),e.jsx("p",{className:"text-gray-400",children:"Please connect your wallet to deposit collateral."})]})});const G=o.length>0?{firstConfig:{mint:o[0].tokenMint,metadata:c[o[0].tokenMint],hasLogo:!!((I=c[o[0].tokenMint])!=null&&I.logoURI)},tokenMetadataCount:Object.keys(c).length}:{noConfigs:!0};return console.log("Render debug info:",G),e.jsxs("div",{className:"w-full bg-gray-950 text-white min-h-screen",children:[e.jsx("div",{className:"fixed bottom-4 right-4 bg-black/80 p-3 rounded-lg text-xs z-50 max-w-xs",children:e.jsxs("div",{className:"font-mono",children:[e.jsxs("div",{children:["Tokens: ",o.length]}),e.jsxs("div",{children:["Metadata: ",Object.keys(c).length]}),o.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{children:["First token: ",o[0].tokenMint.slice(0,6),"...",o[0].tokenMint.slice(-4)]}),e.jsxs("div",{children:["Name: ",((L=c[o[0].tokenMint])==null?void 0:L.name)||"Loading..."]}),e.jsxs("div",{children:["Has logo: ",(B=c[o[0].tokenMint])!=null&&B.logoURI?"✅":"❌"]})]})]})}),e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 py-12",children:[e.jsxs($.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"mb-12",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-white",children:"Deposit Collateral"}),e.jsx("p",{className:"text-lg text-gray-400 mt-2",children:"Select a token and deposit funds to use as collateral."})]}),h?e.jsx(Te,{}):o.length===0?e.jsx("div",{className:"text-center py-16",children:e.jsx("p",{className:"text-gray-400",children:"No token configurations found."})}):e.jsx($.div,{className:"space-y-6",variants:Z,initial:"hidden",animate:"visible",children:o.map(t=>{var n,d,f,u;const a=F(t.tokenMint),r=w[t.tokenMint]||new m(0),s=Se(r);return e.jsxs(ue,{className:"bg-gray-900/50 border-gray-800 overflow-hidden",children:[e.jsx(me,{children:e.jsxs(ge,{className:"text-xl text-white flex items-center gap-3",children:[e.jsxs("div",{className:"relative",style:{width:36,height:36},children:[e.jsx(be,{mintAddress:t.tokenMint,size:36,className:"border border-purple-500/30"}),!((n=c[t.tokenMint])!=null&&n.logoURI)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-xs font-bold text-white",children:t.tokenMint.slice(0,2).toUpperCase()})]}),e.jsxs("span",{className:"break-all ml-3",children:[((d=c[t.tokenMint])==null?void 0:d.name)||"Token",e.jsxs("span",{className:"text-sm text-gray-400 block mt-1",children:[((f=c[t.tokenMint])==null?void 0:f.symbol)||"TOKEN",P[t.tokenMint]>0&&e.jsxs("span",{className:"ml-2 text-green-400",children:["($",(P[t.tokenMint]/1e4).toFixed(4),")"]})]})]})]})}),e.jsxs(he,{className:"space-y-4",children:[e.jsx("div",{className:"relative",children:e.jsx(ke,{type:"number",step:"any",min:"0",value:s,placeholder:"0.00",onChange:g=>W(t.tokenMint,g.target.value),disabled:a.isLoading,className:"bg-gray-800 border-gray-700 h-12 text-lg"})}),e.jsx(ne,{className:"w-full h-11 text-base bg-purple-600 hover:bg-purple-700 text-white",onClick:()=>U(t),disabled:a.isLoading||r.isZero(),children:a.isLoading?e.jsx(je,{className:"h-5 w-5 animate-spin"}):"Deposit Collateral"}),a.txSig&&e.jsxs("div",{className:"bg-green-900/30 text-green-400 text-sm p-3 border border-green-800 rounded-md flex items-start gap-2",children:[e.jsx(re,{className:"h-4 w-4 mt-0.5 flex-shrink-0"}),e.jsx("div",{className:"flex-grow min-w-0",children:e.jsxs("a",{href:`https://explorer.solana.com/tx/${a.txSig}?cluster=devnet`,target:"_blank",rel:"noreferrer",className:"text-green-400 hover:text-green-300 underline flex items-center",children:["View Transaction ",e.jsx(Ne,{className:"h-3 w-3 ml-1"})]})})]}),e.jsx("div",{className:"mt-4",children:((u=j[t.tokenMint])==null?void 0:u.error)&&e.jsx("div",{className:"mb-4",children:e.jsx(Ce,{message:j[t.tokenMint].error,onDismiss:()=>q(t.tokenMint)})})})]})]},t.publicKey)})})]})]})}export{qe as default};
