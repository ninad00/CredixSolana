import{j as I,q as e,x as G,y as $,z as w,D as he,P as d,B as u,A as O,S as q,w as fe}from"./index-B7vkYCve.js";import{C as pe,g as U,c as W,A as ee,T as se,a as ue,b as xe}from"./fetchallaccounts-CPPSWCQ-.js";import{d as be,C as we,c as ye,b as ke,g as K,D as Pe}from"./source-B7nfvOd2.js";import{g as X,u as Z}from"./hf-Bac-RGgZ.js";import{I as te}from"./input-BzVyemLo.js";import{W as Ae}from"./wallet-BDKyIvfy.js";import{P as Ne}from"./piggy-bank-BKjwlWcb.js";import{u as je}from"./useAnchorWallet-BHa7C_ie.js";const ae=c=>{const s=parseFloat(c);return isNaN(s)||s<0?new w(0):new w(Math.floor(s*1e6))},Be={HzwqbKZw8HxMN6bF2yFZNrht3c2iXXzpKcFu7uBEDKtr:"EURC","4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU":"USDC"},Se=c=>{const s=Be[c];return s?`${s} (${c.slice(0,4)}...${c.slice(-4)})`:`${c.slice(0,4)}...${c.slice(-4)}`},ve=()=>e.jsx("div",{className:"space-y-6",children:[...Array(2)].map((c,s)=>e.jsxs("div",{className:"bg-gray-900/50 border-gray-800 rounded-xl p-6 space-y-4 animate-pulse",children:[e.jsx("div",{className:"h-6 bg-gray-700 rounded w-1/3"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("div",{className:"h-12 bg-gray-700 rounded"}),e.jsx("div",{className:"h-12 bg-gray-700 rounded"})]}),e.jsx("div",{className:"h-10 bg-gray-700 rounded w-full"})]},s))});function Te(){const c=fe();return e.jsxs("div",{className:"text-center py-24",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-gray-900 border-2 border-gray-800 rounded-full flex items-center justify-center mb-4",children:e.jsx(Ne,{className:"h-8 w-8 text-gray-600"})}),e.jsx("h3",{className:"text-xl font-semibold text-white",children:"No Deposits Found"}),e.jsx("p",{className:"text-gray-500 mt-2",children:"Get started by depositing collateral on the main page."}),e.jsx($,{onClick:()=>c("/deposit"),variant:"outline",className:"mt-6 border-gray-700 hover:bg-gray-800",children:"Make a Deposit"})]})}const De=({hf:c})=>{if(c==="18446744073709551615")return e.jsx("span",{className:"text-green-400 font-semibold",children:"Infinite"});const s=parseFloat(c)/1e6,V=s>1.5?"text-green-400":s>1.1?"text-yellow-400":"text-red-400";return e.jsx("span",{className:`${V} font-semibold`,children:s.toFixed(4)})};function ze(){const c=Pe,s=je(),[V,ne]=I.useState([]),[re,J]=I.useState(!0),[Y,ie]=I.useState({}),[F,Q]=I.useState({}),m=(l,r)=>{Q(o=>({...o,[l]:{...o[l],...r}}))},oe=async(l,r)=>{if(!(s!=null&&s.publicKey)||!s.signTransaction)return;const o=F[r];if(!o||o.isProcessing)return;m(r,{isProcessing:!0,processingAction:"mint",error:null,txSig:null});const t=K(s);if(!t){m(r,{isProcessing:!1,processingAction:null,error:"Program not available"});return}try{const a=s.publicKey,i=new d(l.tokenMint),p=new d(c),[y]=d.findProgramAddressSync([u.from("engine")],t.programId),[k]=d.findProgramAddressSync([u.from("user"),a.toBuffer(),i.toBuffer()],t.programId),[N]=d.findProgramAddressSync([u.from("price"),i.toBuffer()],t.programId),[j]=d.findProgramAddressSync([u.from("config"),i.toBuffer()],t.programId),[P]=d.findProgramAddressSync([u.from("deposit"),a.toBuffer(),i.toBuffer()],t.programId),n=t.provider.connection,g=await U(p,a);if(!await n.getAccountInfo(g)){const A=W(a,g,a,p),b=new O().add(A),{blockhash:T,lastValidBlockHeight:D}=await n.getLatestBlockhash("finalized");b.recentBlockhash=T,b.lastValidBlockHeight=D,b.feePayer=a;const ge=await s.signTransaction(b),me=await n.sendRawTransaction(ge.serialize());await n.confirmTransaction({blockhash:T,lastValidBlockHeight:D,signature:me})}const h=await X(i.toBase58()),C=w.isBN(h)?h:new w(h),B=await t.methods.mintDsc(o.mintAmount,C).accountsStrict({engine:y,userData:k,tokenMint:i,user:a,dscMint:p,deposit:P,config:j,price:N,userDscAccount:g,systemProgram:q.programId,tokenProgram:se,associatedTokenProgram:ee}).transaction(),{blockhash:_,lastValidBlockHeight:L}=await n.getLatestBlockhash("confirmed");B.recentBlockhash=_,B.lastValidBlockHeight=L,B.feePayer=a;const S=await s.signTransaction(B),E=await n.sendRawTransaction(S.serialize());await n.confirmTransaction({blockhash:_,lastValidBlockHeight:L,signature:E});const R=await Z(a,i,t),v=await t.methods.temp(R).accountsStrict({user:a,userData:k,tokenMint:i}).transaction(),{blockhash:H,lastValidBlockHeight:z}=await n.getLatestBlockhash("confirmed");v.recentBlockhash=H,v.lastValidBlockHeight=z,v.feePayer=a;const M=await s.signTransaction(v),f=await n.sendRawTransaction(M.serialize());await n.confirmTransaction({blockhash:H,lastValidBlockHeight:z,signature:f}),m(r,{isProcessing:!1,processingAction:null,txSig:f})}catch(a){console.error("Mint DSC error:",a),m(r,{isProcessing:!1,processingAction:null,error:a instanceof Error?a.message:"Unknown error"})}},ce=async(l,r)=>{if(!(s!=null&&s.publicKey)||!s.signTransaction)return;const o=F[r];if(!o||o.isProcessing)return;m(r,{isProcessing:!0,processingAction:"withdraw",error:null,txSig:null});const t=K(s);if(!t){m(r,{isProcessing:!1,processingAction:null,error:"Program not available"});return}try{const a=s.publicKey,i=new d(l.tokenMint),p=new d(c),[y]=d.findProgramAddressSync([u.from("engine")],t.programId),[k]=d.findProgramAddressSync([u.from("user"),a.toBuffer(),i.toBuffer()],t.programId),[N]=d.findProgramAddressSync([u.from("price"),i.toBuffer()],t.programId),[j]=d.findProgramAddressSync([u.from("config"),i.toBuffer()],t.programId),[P]=d.findProgramAddressSync([u.from("deposit"),a.toBuffer(),i.toBuffer()],t.programId),n=t.provider.connection,g=await U(i,j,!0),x=await U(i,a),h=await U(p,a),C=await X(i.toBase58()),B=w.isBN(C)?C:new w(C);if(!await n.getAccountInfo(h)){const M=W(a,h,a,p),f=new O().add(M),{blockhash:A,lastValidBlockHeight:b}=await n.getLatestBlockhash("finalized");f.recentBlockhash=A,f.lastValidBlockHeight=b,f.feePayer=a;const T=await s.signTransaction(f),D=await n.sendRawTransaction(T.serialize());await n.confirmTransaction({blockhash:A,lastValidBlockHeight:b,signature:D})}if(!await n.getAccountInfo(x)){const M=W(a,x,a,i),f=new O().add(M),{blockhash:A,lastValidBlockHeight:b}=await n.getLatestBlockhash("finalized");f.recentBlockhash=A,f.lastValidBlockHeight=b,f.feePayer=a;const T=await s.signTransaction(f),D=await n.sendRawTransaction(T.serialize());await n.confirmTransaction({blockhash:A,lastValidBlockHeight:b,signature:D})}const S=await t.methods.withdrawCollateral(o.withdrawAmount,B).accountsStrict({user:a,userData:k,engine:y,tokenMint:i,dscMint:p,deposit:P,price:N,config:j,vault:g,userTokenAccount:x,userDscAccount:h,systemProgram:q.programId,associatedTokenProgram:ee,tokenProgram:se}).transaction(),{blockhash:E,lastValidBlockHeight:R}=await n.getLatestBlockhash("confirmed");S.recentBlockhash=E,S.lastValidBlockHeight=R,S.feePayer=s.publicKey;const v=await s.signTransaction(S),H=await n.sendRawTransaction(v.serialize());await n.confirmTransaction({blockhash:E,lastValidBlockHeight:R,signature:H});const z=await Z(a,i,t);await t.methods.temp(z).accountsStrict({user:a,userData:k,tokenMint:i}).rpc(),m(r,{isProcessing:!1,processingAction:null,txSig:H})}catch(a){console.error("Withdraw error:",a),m(r,{isProcessing:!1,processingAction:null,error:a instanceof Error?a.message:"Unknown error"})}},le=async(l,r)=>{if(!(s!=null&&s.publicKey)||!s.signTransaction)return;const o=F[r];if(!o||o.isProcessing)return;m(r,{isProcessing:!0,processingAction:"hf",error:null,txSig:null});const t=K(s);if(!t){m(r,{isProcessing:!1,processingAction:null,error:"Program not available"});return}try{const a=s.publicKey,i=new d(l.tokenMint),[p]=d.findProgramAddressSync([u.from("user"),a.toBuffer(),i.toBuffer()],t.programId),y=await Z(a,i,t);await t.methods.temp(y).accountsStrict({user:a,userData:p,tokenMint:i}).rpc(),m(r,{isProcessing:!1,processingAction:null,txSig:"Health Factor Updated"})}catch(a){console.error("health_factor error :",a),m(r,{isProcessing:!1,processingAction:null,error:a instanceof Error?a.message:"Unknown error"})}};I.useEffect(()=>{(async()=>{if(s){J(!0);try{const[r,o]=await Promise.all([ue(s),xe(s)]),t=r.filter(n=>n.user===s.publicKey.toBase58()),a=o.filter(n=>n.user===s.publicKey.toBase58()),i=t.filter((n,g,x)=>g===x.findIndex(h=>h.publicKey===n.publicKey)),p=a.filter((n,g,x)=>g===x.findIndex(h=>h.publicKey===n.publicKey)),y=new Map;p.forEach(n=>{y.set(n.primaryToken,n)});const k=i.map((n,g)=>{const x=y.get(n.tokenMint)||null,h=`${n.publicKey}_${g}`;return{deposit:n,userData:x,uniqueKey:h}});ne(k);const N={};k.forEach(({uniqueKey:n})=>{N[n]={mintAmount:new w(0),withdrawAmount:new w(0),isProcessing:!1,processingAction:null,txSig:null,error:null}}),Q(N);const j=Array.from(new Set(i.map(n=>n.tokenMint))),P={};for(const n of j)try{const g=await X(n);P[n]=Number(g.toString())}catch(g){console.error(`Error fetching price for ${n}:`,g),P[n]=0}ie(P)}catch(r){console.error("Error loading data:",r)}finally{J(!1)}}})()},[s]);const de={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}};return e.jsx("div",{className:"w-full bg-gray-950 text-white min-h-screen",children:e.jsxs("div",{className:"max-w-5xl mx-auto px-4 sm:px-6 py-12",children:[e.jsxs(G.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"mb-12",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-white",children:"My Positions"}),e.jsx("p",{className:"text-lg text-gray-400 mt-2",children:"Manage your deposited collateral, mint DSC, and monitor your account health."})]}),re?e.jsx(ve,{}):V.length===0?e.jsx(Te,{}):e.jsx(G.div,{className:"space-y-6",variants:de,initial:"hidden",animate:"visible",children:V.map(({deposit:l,userData:r,uniqueKey:o})=>{const t=F[o];return t?e.jsxs(be,{className:"bg-gray-900/50 border-gray-800 overflow-hidden",children:[e.jsx(we,{className:"!pb-4",children:e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs(ye,{className:"text-xl text-white flex items-center gap-3",children:[e.jsx("span",{className:"p-2 bg-purple-600/20 border border-purple-500/30 rounded-md",children:e.jsx(Ae,{className:"h-5 w-5 text-purple-400"})}),`Position: ${Se(l.tokenMint)}`]})})}),e.jsxs(ke,{className:"grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6",children:[e.jsxs("div",{className:"bg-gray-900 border border-gray-800 rounded-lg p-4 space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-baseline",children:[e.jsx("span",{className:"text-gray-400",children:"Collateral Balance"}),e.jsx("span",{className:"font-mono text-lg text-white",children:(parseFloat((r==null?void 0:r.tokenBalance)||"0")/1e6).toFixed(4)})]}),e.jsxs("div",{className:"flex justify-between items-baseline",children:[e.jsx("span",{className:"text-gray-400",children:"DSC Borrowed"}),e.jsx("span",{className:"font-mono text-lg text-white",children:(parseFloat((r==null?void 0:r.borrowedAmount)||"0")/1e6).toFixed(4)})]}),e.jsxs("div",{className:"flex justify-between items-baseline",children:[e.jsx("span",{className:"text-gray-400",children:"Health Factor"}),e.jsx(De,{hf:(r==null?void 0:r.hf)||"0"})]}),e.jsxs("div",{className:"flex justify-between items-baseline pt-2 border-t border-gray-800",children:[e.jsx("span",{className:"text-gray-400",children:"Token Price"}),e.jsxs("span",{className:"font-mono text-lg text-white",children:["$",Y[l.tokenMint]?(Y[l.tokenMint]/1e4).toFixed(4):"0.00"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(te,{type:"number",step:"any",min:"0",value:(Number(t.mintAmount.toString())/1e6).toString(),onChange:a=>m(o,{mintAmount:ae(a.target.value)}),placeholder:"0.00",disabled:t.isProcessing,className:"bg-gray-800 border-gray-700 h-12 text-lg pr-28"}),e.jsx($,{className:"absolute top-1.5 right-1.5 h-9 bg-green-600 hover:bg-green-700 text-white",onClick:()=>oe(l,o),disabled:!(s!=null&&s.publicKey)||t.isProcessing||t.mintAmount.eq(new w(0)),children:t.isProcessing&&t.processingAction==="mint"?"Minting...":"Mint DSC"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(te,{type:"number",step:"any",value:(Number(t.withdrawAmount.toString())/1e6).toString(),onChange:a=>m(o,{withdrawAmount:ae(a.target.value)}),placeholder:"0.00",disabled:t.isProcessing,className:"bg-gray-800 border-gray-700 h-12 text-lg pr-32"}),e.jsx($,{variant:"destructive",className:"absolute top-1.5 right-1.5 h-9 bg-red-600 hover:bg-red-700",onClick:()=>ce(l,o),disabled:!(s!=null&&s.publicKey)||t.isProcessing,children:t.isProcessing&&t.processingAction==="withdraw"?"Withdrawing...":"Withdraw"})]}),e.jsx("div",{className:"grid gap-3",children:e.jsx($,{variant:"outline",className:"h-12 bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>le(l,o),disabled:!(s!=null&&s.publicKey)||t.isProcessing,children:t.isProcessing&&t.processingAction==="hf"?"Refreshing...":"Get HF"})})]})]}),e.jsx(he,{children:t.txSig&&e.jsxs(G.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"bg-green-900/30 text-green-400 text-sm mt-4 mx-6 mb-6 p-3 border border-green-800 rounded-md flex items-start gap-2",children:[e.jsx(pe,{className:"h-4 w-4 mt-0.5 flex-shrink-0"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Success:"}),t.txSig==="Health Factor Updated"?e.jsx("span",{className:"ml-1",children:"Health Factor Refreshed"}):e.jsx("a",{className:"ml-2 text-purple-400 hover:text-purple-300 underline",target:"_blank",rel:"noreferrer",href:`https://explorer.solana.com/tx/${t.txSig}?cluster=devnet`,children:"View Transaction"})]})]})})]},o):null})})]})})}export{ze as default};
