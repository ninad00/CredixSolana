import{j as d,P as v,z as m,B as E,A as G,S as Y,C as J,q as e,x as D,y as Q}from"./index-pi6Ztd27.js";import{c as X,f as ee}from"./fetchallaccounts-CgTnSnyo.js";import{g as te,d as ne,C as ae,a as se,c as oe}from"./source-Ck9LQvm6.js";import{g as re}from"./tp-KL72pMcE.js";import{u as ie}from"./hf-DuzolikA.js";import{I as le}from"./input-XN1kasC4.js";import{T as ce,f as de}from"./TokenIcon-UFryZpn9.js";import{g as B,A as me,T as ue}from"./mint--i00LiPk.js";import{W as ge}from"./wallet-B77waLrQ.js";import{L as fe}from"./loader-circle-BiaaNxeP.js";import{C as he}from"./circle-check-big-DtrSUpW8.js";import{E as xe}from"./external-link-CKps6vRp.js";import{u as pe}from"./useAnchorWallet-mr6MGh28.js";const w=6,ke=i=>{if(!i)return new m(0);try{const o=i.split("."),p=new m(o[0]||0);let g=new m(0);if(o[1]){const b=o[1].slice(0,w).padEnd(w,"0");g=new m(b)}const k=new m(10).pow(new m(w));return p.mul(k).add(g)}catch{return null}},ye=i=>{if(i.isZero())return"";const o=new m(10).pow(new m(w)),p=i.div(o),g=i.mod(o);if(g.isZero())return p.toString();const k=g.toString().padStart(w,"0").replace(/0+$/,"");return`${p.toString()}.${k||"0"}`},be=()=>e.jsx("div",{className:"space-y-6",children:[...Array(2)].map((i,o)=>e.jsxs("div",{className:"bg-gray-900/50 border-gray-800 rounded-xl p-6 space-y-4 animate-pulse",children:[e.jsx("div",{className:"h-6 bg-gray-700 rounded w-1/2"}),e.jsx("div",{className:"h-12 bg-gray-700 rounded"}),e.jsx("div",{className:"h-10 bg-gray-700 rounded w-full"})]},o))});function Ke(){var C,P,I;const i=pe(),[o,p]=d.useState([]),[g,k]=d.useState(!0),[b,M]=d.useState({}),[S,K]=d.useState({}),[l,$]=d.useState({}),[T,O]=d.useState({}),u=d.useCallback((n,a)=>{K(r=>({...r,[n]:{...r[n],...a}}))},[]),R=d.useCallback(n=>S[n]||{isLoading:!1,txSig:null,error:null},[S]),_=d.useCallback(async n=>{if(!(i!=null&&i.publicKey))return;const a=te(i);if(!a)return;const r=b[n.tokenMint];if(!r||r.isZero()){u(n.tokenMint,{error:"Please enter a valid amount"});return}u(n.tokenMint,{isLoading:!0,error:null,txSig:null});try{const s=i.publicKey,t=new v(n.tokenMint),c=new v(n.publicKey),f=await B(t,c,!0),h=a.provider.connection,x=await B(t,s);if(!await h.getAccountInfo(x)){u(n.tokenMint,{isLoading:!1,error:`Token account ${x.toString()} does not exist. Please ensure you have some tokens to deposit.`});return}const y=await h.getTokenAccountBalance(x);if(console.log("Token balance:",{mint:t.toString(),userTokenAccount:x.toString(),balance:y.value.uiAmount,decimals:y.value.decimals,requestedAmount:r.toString(),requestedUiAmount:Number(r)/Math.pow(10,y.value.decimals)}),new m(y.value.amount).lt(r)){u(n.tokenMint,{isLoading:!1,error:`Insufficient balance. You have ${y.value.uiAmount} tokens but trying to deposit ${Number(r)/Math.pow(10,y.value.decimals)}`});return}const[L]=v.findProgramAddressSync([E.from("deposit"),s.toBuffer(),t.toBuffer()],a.programId),[N]=v.findProgramAddressSync([E.from("user"),s.toBuffer(),t.toBuffer()],a.programId);if(console.log("Program addresses:",{depositPDA:L.toString(),userPDA:N.toString(),vaultATA:f.toString()}),!await h.getAccountInfo(x)){const A=X(s,x,s,t),j=new G().add(A),{blockhash:V,lastValidBlockHeight:W}=await h.getLatestBlockhash("confirmed");j.recentBlockhash=V,j.lastValidBlockHeight=W,j.feePayer=i.publicKey;const Z=await i.signTransaction(j);await h.sendRawTransaction(Z.serialize())}const H=await a.methods.depositCollateral(r).accountsStrict({user:i.publicKey,tokenMint:t,userTokenAccount:x,userData:N,deposit:L,config:c,vault:f,tokenProgram:ue,systemProgram:Y.programId,associatedTokenProgram:me}).rpc();u(n.tokenMint,{isLoading:!1,txSig:H}),M(A=>({...A,[n.tokenMint]:new m(0)}));const z=await ie(s,t,a);await a.methods.temp(z).accountsStrict({user:s,userData:N,tokenMint:t}).rpc()}catch(s){console.error("Transaction failed:",s);let t="An unknown error occurred.";s instanceof J?(s.logs||[]).some(f=>f.includes("insufficient funds"))?t="Transaction failed due to insufficient funds. Please check your token balance.":t="Transaction simulation failed. See console for details.":s instanceof Error&&(t=s.message),u(n.tokenMint,{isLoading:!1,error:t})}},[i,b,u,M]),F=(n,a)=>{const r=ke(a);r!==null&&M(s=>({...s,[n]:r})),u(n,{error:null})};d.useEffect(()=>{console.log("Configs changed, loading metadata for:",o.map(a=>{var r;return{mint:a.tokenMint,name:((r=l[a.tokenMint])==null?void 0:r.name)||"Not loaded"}}));const n=async()=>{const a={},r=o.filter(s=>!l[s.tokenMint]);console.log(`Fetching metadata for ${r.length} tokens:`,r.map(s=>s.tokenMint.slice(0,4)+"..."+s.tokenMint.slice(-4)));try{(await Promise.allSettled(r.map(t=>de(t.tokenMint).then(c=>({tokenMint:t.tokenMint,metadata:c}))))).forEach(t=>{t.status==="fulfilled"&&t.value.metadata?(console.log(`Fetched metadata for ${t.value.tokenMint}:`,t.value.metadata),a[t.value.tokenMint]=t.value.metadata):t.status==="rejected"&&console.error("Error fetching token metadata:",t.reason)}),Object.keys(a).length>0?(console.log("Updating token metadata map with new entries"),$(t=>({...t,...a}))):console.log("No new token metadata to update")}catch(s){console.error("Error in token metadata loading batch:",s)}};o.length>0&&n()},[o,l]),d.useEffect(()=>{if(!i)return;(async()=>{k(!0);try{const a=await ee(i);p(a);const r=[...new Set(a.map(t=>t.tokenMint))],s={};for(const t of r)try{const c=await re(t);s[t]=Number(c.toString())}catch(c){console.error(`Error fetching price for token ${t}:`,c),s[t]=0}O(s)}catch(a){console.error("Error loading configs:",a)}finally{k(!1)}})()},[i]);const U={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}};if(!i)return e.jsx("div",{className:"w-full bg-gray-950 text-white min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-gray-900 border-2 border-gray-800 rounded-full flex items-center justify-center mb-4",children:e.jsx(ge,{className:"h-8 w-8 text-gray-600"})}),e.jsx("h2",{className:"text-2xl font-bold mb-2 text-white",children:"Connect Wallet"}),e.jsx("p",{className:"text-gray-400",children:"Please connect your wallet to deposit collateral."})]})});const q=o.length>0?{firstConfig:{mint:o[0].tokenMint,metadata:l[o[0].tokenMint],hasLogo:!!((C=l[o[0].tokenMint])!=null&&C.logoURI)},tokenMetadataCount:Object.keys(l).length}:{noConfigs:!0};return console.log("Render debug info:",q),e.jsxs("div",{className:"w-full bg-gray-950 text-white min-h-screen",children:[e.jsx("div",{className:"fixed bottom-4 right-4 bg-black/80 p-3 rounded-lg text-xs z-50 max-w-xs",children:e.jsxs("div",{className:"font-mono",children:[e.jsxs("div",{children:["Tokens: ",o.length]}),e.jsxs("div",{children:["Metadata: ",Object.keys(l).length]}),o.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{children:["First token: ",o[0].tokenMint.slice(0,6),"...",o[0].tokenMint.slice(-4)]}),e.jsxs("div",{children:["Name: ",((P=l[o[0].tokenMint])==null?void 0:P.name)||"Loading..."]}),e.jsxs("div",{children:["Has logo: ",(I=l[o[0].tokenMint])!=null&&I.logoURI?"✅":"❌"]})]})]})}),e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 py-12",children:[e.jsxs(D.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"mb-12",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-white",children:"Deposit Collateral"}),e.jsx("p",{className:"text-lg text-gray-400 mt-2",children:"Select a token and deposit funds to use as collateral."})]}),g?e.jsx(be,{}):o.length===0?e.jsx("div",{className:"text-center py-16",children:e.jsx("p",{className:"text-gray-400",children:"No token configurations found."})}):e.jsx(D.div,{className:"space-y-6",variants:U,initial:"hidden",animate:"visible",children:o.map(n=>{var t,c,f;const a=R(n.tokenMint),r=b[n.tokenMint]||new m(0),s=ye(r);return e.jsxs(ne,{className:"bg-gray-900/50 border-gray-800 overflow-hidden",children:[e.jsx(ae,{children:e.jsxs(se,{className:"text-xl text-white flex items-center gap-3",children:[e.jsxs("div",{className:"relative",style:{width:36,height:36},children:[e.jsx(ce,{mintAddress:n.tokenMint,size:36,className:"border border-purple-500/30"}),!((t=l[n.tokenMint])!=null&&t.logoURI)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-xs font-bold text-white",children:n.tokenMint.slice(0,2).toUpperCase()})]}),e.jsxs("span",{className:"break-all ml-3",children:[((c=l[n.tokenMint])==null?void 0:c.name)||"Token",e.jsxs("span",{className:"text-sm text-gray-400 block mt-1",children:[((f=l[n.tokenMint])==null?void 0:f.symbol)||"TOKEN",T[n.tokenMint]>0&&e.jsxs("span",{className:"ml-2 text-green-400",children:["($",(T[n.tokenMint]/1e4).toFixed(4),")"]})]})]})]})}),e.jsxs(oe,{className:"space-y-4",children:[e.jsx("div",{className:"relative",children:e.jsx(le,{type:"number",step:"any",min:"0",value:s,placeholder:"0.00",onChange:h=>F(n.tokenMint,h.target.value),disabled:a.isLoading,className:"bg-gray-800 border-gray-700 h-12 text-lg"})}),e.jsx(Q,{className:"w-full h-11 text-base bg-purple-600 hover:bg-purple-700 text-white",onClick:()=>_(n),disabled:a.isLoading||r.isZero(),children:a.isLoading?e.jsx(fe,{className:"h-5 w-5 animate-spin"}):"Deposit Collateral"}),a.txSig&&e.jsxs("div",{className:"bg-green-900/30 text-green-400 text-sm p-3 border border-green-800 rounded-md flex items-start gap-2",children:[e.jsx(he,{className:"h-4 w-4 mt-0.5 flex-shrink-0"}),e.jsx("div",{className:"flex-grow min-w-0",children:e.jsxs("a",{href:`https://explorer.solana.com/tx/${a.txSig}?cluster=devnet`,target:"_blank",rel:"noreferrer",className:"text-green-400 hover:text-green-300 underline flex items-center",children:["View Transaction ",e.jsx(xe,{className:"h-3 w-3 ml-1"})]})})]})]})]},n.publicKey)})})]})]})}export{Ke as default};
