import{c as X,j as b,q as e,x as $,y as Y,z as g,D as ee,P as f,B as A,A as E,S as te}from"./index-CjnjuBa7.js";import{c as H,a as se,b as ae}from"./fetchallaccounts-BRQD7MY-.js";import{d as re,C as ne,a as oe,c as ie,g as ce,D as le}from"./source-D5IHAeb_.js";import{g as V}from"./tp-CZobGuSk.js";import{u as de}from"./hf-BH-kT0Hj.js";import{I as me}from"./input-DVR8wwFN.js";import{L as ge}from"./loader-circle-7ldIs9E8.js";import{C as F}from"./circle-check-big-B4TZtbPP.js";import{u as xe}from"./useAnchorWallet-BEAn8DEn.js";import{g as _,A as fe,T as he}from"./mint-D2J8TJV_.js";/**
 * @license lucide-react v0.516.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],pe=X("triangle-alert",ue),be=l=>{const t=parseFloat(l);return isNaN(t)||t<0?new g(0):new g(Math.floor(t*1e6))},z=l=>{const t=typeof l=="string"?new g(l):l,y=new g(10).pow(new g(6)),v=t.div(y),S=t.mod(y);if(S.isZero())return v.toString();const k=S.toString().padStart(6,"0").replace(/0+$/,"");return`${v.toString()}.${k||"0"}`},R=l=>`${l.slice(0,4)}...${l.slice(-4)}`,ye=()=>e.jsx("div",{className:"space-y-6",children:[...Array(2)].map((l,t)=>e.jsxs("div",{className:"bg-gray-900/50 border-gray-800 rounded-xl p-6 space-y-4 animate-pulse",children:[e.jsx("div",{className:"h-6 bg-gray-700 rounded w-1/2"}),e.jsx("div",{className:"h-20 bg-gray-700 rounded"}),e.jsx("div",{className:"h-12 bg-gray-700 rounded"})]},t))}),we=()=>e.jsxs("div",{className:"text-center py-24",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-gray-900 border-2 border-gray-800 rounded-full flex items-center justify-center mb-4",children:e.jsx(F,{className:"h-8 w-8 text-green-500"})}),e.jsx("h3",{className:"text-xl font-semibold text-white",children:"All Positions Are Healthy"}),e.jsx("p",{className:"text-gray-500 mt-2",children:"There are currently no positions eligible for liquidation."})]});function $e(){const l=le,t=xe(),[y,v]=b.useState([]),[S,k]=b.useState(!0),[je,O]=b.useState({}),[q,L]=b.useState({}),w=b.useCallback((d,n)=>{L(i=>({...i,[d]:{...i[d],...n}}))},[]),U=async(d,n)=>{if(!(t!=null&&t.publicKey)||!t.signTransaction)return;const i=q[n];if(!i||i.isProcessing)return;w(n,{isProcessing:!0,error:null,txSig:null});const a=ce(t);if(!a){w(n,{isProcessing:!1,error:"Program not available"});return}try{const r=t.publicKey,h=new f(d.user),o=new f(d.tokenMint),u=new f(l),[P]=f.findProgramAddressSync([A.from("engine")],a.programId),[p]=f.findProgramAddressSync([A.from("user"),h.toBuffer(),o.toBuffer()],a.programId),[s]=f.findProgramAddressSync([A.from("price"),o.toBuffer()],a.programId),[c]=f.findProgramAddressSync([A.from("config"),o.toBuffer()],a.programId),[K]=f.findProgramAddressSync([A.from("deposit"),h.toBuffer(),o.toBuffer()],a.programId),x=a.provider.connection,W=await _(o,c,!0),T=await _(o,r),C=await _(u,r),B=await V(o.toBase58()),Z=g.isBN(B)?B:new g(B);if(!await x.getAccountInfo(C)){const D=H(r,C,r,u),m=new E().add(D),{blockhash:j,lastValidBlockHeight:N}=await x.getLatestBlockhash("finalized");m.recentBlockhash=j,m.lastValidBlockHeight=N,m.feePayer=r;const M=await t.signTransaction(m),I=await x.sendRawTransaction(M.serialize());await x.confirmTransaction({blockhash:j,lastValidBlockHeight:N,signature:I})}if(!await x.getAccountInfo(T)){const D=H(r,T,r,o),m=new E().add(D),{blockhash:j,lastValidBlockHeight:N}=await x.getLatestBlockhash("finalized");m.recentBlockhash=j,m.lastValidBlockHeight=N,m.feePayer=r;const M=await t.signTransaction(m),I=await x.sendRawTransaction(M.serialize());await x.confirmTransaction({blockhash:j,lastValidBlockHeight:N,signature:I})}const J=await a.methods.liquidateUser(i.debtToCover,Z).accountsStrict({engine:P,userData:p,deposit:K,liquidator:t.publicKey,tokenMint:o,config:c,vault:W,liquidatorTokenAccount:T,dscMint:u,liquidatorDscAccount:C,price:s,systemProgram:te.programId,tokenProgram:he,associatedTokenProgram:fe}).rpc(),Q=await de(h,o,a);await a.methods.temp(Q).accountsStrict({user:h,userData:p,tokenMint:o}).rpc(),w(n,{isProcessing:!1,txSig:J})}catch(r){console.error("Liquidation error:",r),w(n,{isProcessing:!1,error:r instanceof Error?r.message:"Unknown error occurred"})}};b.useEffect(()=>{if(!t)return;(async()=>{k(!0);try{const[n,i]=await Promise.all([se(t),ae(t)]),a=new Set,r=n.filter(s=>{const c=`${s.user}_${s.tokenMint}`;return a.has(c)?!1:(a.add(c),!0)}),h=new Map;i.forEach(s=>{const c=`${s.user}_${s.primaryToken}`;h.set(c,s)});const o=r.map((s,c)=>({deposit:s,userData:h.get(`${s.user}_${s.tokenMint}`)||null,uniqueKey:`${s.publicKey}_${c}`})).filter(({userData:s})=>s?parseFloat(s.hf)/1e6<1&&s.hf!=="18446744073709551615":!1);v(o);const u={};o.forEach(({uniqueKey:s})=>{u[s]={debtToCover:new g(0),isProcessing:!1,txSig:null,error:null}}),L(u);const P=Array.from(new Set(o.map(s=>s.deposit.tokenMint))),p={};for(const s of P)try{const c=await V(s);p[s]=Number(c.toString())}catch{p[s]=0}O(p)}catch(n){console.error("Error loading data:",n)}finally{k(!1)}})()},[t]);const G={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}};return e.jsx("div",{className:"w-full bg-gray-950 text-white min-h-screen",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 py-12",children:[e.jsxs($.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"mb-12",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-white",children:"Liquidate Positions"}),e.jsx("p",{className:"text-lg text-gray-400 mt-2",children:"Browse and liquidate undercollateralized positions to earn a bonus."})]}),S?e.jsx(ye,{}):y.length===0?e.jsx(we,{}):e.jsx($.div,{className:"space-y-6",variants:G,initial:"hidden",animate:"visible",children:y.map(({deposit:d,userData:n,uniqueKey:i})=>{const a=q[i];return a?e.jsxs(re,{className:"bg-gray-900/50 border-gray-800 overflow-hidden",children:[e.jsx(ne,{children:e.jsxs(oe,{className:"text-xl text-white flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"p-2 bg-red-600/20 border border-red-500/30 rounded-md",children:e.jsx(pe,{className:"h-5 w-5 text-red-400"})}),`User: ${R(d.user)}`]}),e.jsx("span",{className:"text-sm font-mono text-gray-400",children:R(d.tokenMint)})]})}),e.jsxs(ie,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-900 border border-gray-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-sm text-gray-400",children:"Health Factor"}),e.jsx("span",{className:"font-mono text-lg text-red-400 font-bold",children:(parseFloat(n.hf)/1e6).toFixed(4)})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-sm text-gray-400",children:"Collateral"}),e.jsx("span",{className:"font-mono text-lg text-white",children:z(n.tokenBalance)})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-sm text-gray-400",children:"Debt (DSC)"}),e.jsx("span",{className:"font-mono text-lg text-white",children:z(n.borrowedAmount)})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(me,{type:"number",step:"any",min:"0",value:(Number(a.debtToCover.toString())/1e6).toString(),onChange:r=>w(i,{debtToCover:be(r.target.value)}),placeholder:"Amount of debt to cover",disabled:a.isProcessing,className:"bg-gray-800 border-gray-700 h-12 text-lg pr-28"}),e.jsx(Y,{className:"absolute top-1.5 right-1.5 h-9 bg-red-600 hover:bg-red-700 text-white",onClick:()=>U(d,i),disabled:!(t!=null&&t.publicKey)||a.isProcessing||a.debtToCover.eq(new g(0)),children:a.isProcessing?e.jsx(ge,{className:"h-4 w-4 animate-spin"}):"Liquidate"})]}),e.jsx(ee,{children:a.txSig&&e.jsxs($.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"bg-green-900/30 text-green-400 text-sm p-3 border border-green-800 rounded-md flex items-start gap-2",children:[e.jsx(F,{className:"h-4 w-4 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("strong",{children:"Success:"}),e.jsx("a",{href:`https://explorer.solana.com/tx/${a.txSig}?cluster=devnet`,target:"_blank",rel:"noreferrer",className:"ml-2 text-purple-400 hover:text-purple-300 underline break-all",children:"View Transaction"})]})]})})]})]},i):null})})]})})}export{$e as default};
