import{c as ee,j as l,q as e,x as $,z as u,y as te,P as v,B as O,A as ae,S as ne,C as se}from"./index-CwPIP1s7.js";import{C as oe,g as _,c as re,A as ie,T as le,f as ce}from"./fetchallaccounts-CeDeNKmR.js";import{d as de,C as ue,c as me,b as ge,g as he}from"./source-8_iv8NpZ.js";import{u as fe,g as xe}from"./hf-QUge15wF.js";import{I as pe}from"./input-LK0agOQL.js";import{T as ke,f as ye}from"./TokenIcon-COpnq7Na.js";import{W as be}from"./wallet-CMtR56WP.js";import{L as we}from"./loader-circle-C8JiTdZv.js";import{u as Me}from"./useAnchorWallet-DlTXfWG1.js";/**
 * @license lucide-react v0.516.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],ve=ee("external-link",je),b=6,Ne=i=>{if(!i)return new u(0);try{const o=i.split("."),p=new u(o[0]||0);let g=new u(0);if(o[1]){const w=o[1].slice(0,b).padEnd(b,"0");g=new u(w)}const k=new u(10).pow(new u(b));return p.mul(k).add(g)}catch{return null}},Ae=i=>{if(i.isZero())return"";const o=new u(10).pow(new u(b)),p=i.div(o),g=i.mod(o);if(g.isZero())return p.toString();const k=g.toString().padStart(b,"0").replace(/0+$/,"");return`${p.toString()}.${k||"0"}`},Se=()=>e.jsx("div",{className:"space-y-6",children:[...Array(2)].map((i,o)=>e.jsxs("div",{className:"bg-gray-900/50 border-gray-800 rounded-xl p-6 space-y-4 animate-pulse",children:[e.jsx("div",{className:"h-6 bg-gray-700 rounded w-1/2"}),e.jsx("div",{className:"h-12 bg-gray-700 rounded"}),e.jsx("div",{className:"h-10 bg-gray-700 rounded w-full"})]},o))});function _e(){var I,L,B;const i=Me(),[o,p]=l.useState([]),[g,k]=l.useState(!0),[w,S]=l.useState({}),[T,C]=l.useState({}),[Te,H]=l.useState(null);l.useCallback(()=>H(null),[]),l.useCallback(a=>{C(n=>({...n,[a]:{...n[a],error:null}}))},[]);const[c,q]=l.useState({}),[P,V]=l.useState({}),h=l.useCallback((a,n)=>{C(r=>({...r,[a]:{...r[a],...n}}))},[]),z=l.useCallback(a=>T[a]||{isLoading:!1,txSig:null,error:null},[T]),F=async a=>{if(!(i!=null&&i.publicKey))return;const n=he(i);if(!n)return;const r=w[a.tokenMint];if(!r||r.isZero()){h(a.tokenMint,{error:"Please enter a valid amount"});return}h(a.tokenMint,{isLoading:!0,error:null,txSig:null});try{const s=i.publicKey,t=new v(a.tokenMint),d=new v(a.publicKey),f=await _(t,d,!0),m=n.provider.connection,x=await _(t,s);if(!await m.getAccountInfo(x)){h(a.tokenMint,{isLoading:!1,error:`Token account ${x.toString()} does not exist. Please ensure you have some tokens to deposit.`});return}const y=await m.getTokenAccountBalance(x);if(console.log("Token balance:",{mint:t.toString(),userTokenAccount:x.toString(),balance:y.value.uiAmount,decimals:y.value.decimals,requestedAmount:r.toString(),requestedUiAmount:Number(r)/Math.pow(10,y.value.decimals)}),new u(y.value.amount).lt(r)){h(a.tokenMint,{isLoading:!1,error:`Insufficient balance. You have ${y.value.uiAmount} tokens but trying to deposit ${Number(r)/Math.pow(10,y.value.decimals)}`});return}const[E]=v.findProgramAddressSync([O.from("deposit"),s.toBuffer(),t.toBuffer()],n.programId),[N]=v.findProgramAddressSync([O.from("user"),s.toBuffer(),t.toBuffer()],n.programId);if(console.log("Program addresses:",{depositPDA:E.toString(),userPDA:N.toString(),vaultATA:f.toString()}),!await m.getAccountInfo(x)){const A=re(s,x,s,t),j=new ae().add(A),{blockhash:J,lastValidBlockHeight:Q}=await m.getLatestBlockhash("finalized");j.recentBlockhash=J,j.lastValidBlockHeight=Q,j.feePayer=i.publicKey;const X=await i.signTransaction(j);await m.sendRawTransaction(X.serialize())}const M=await n.methods.depositCollateral(r).accountsStrict({user:i.publicKey,tokenMint:t,userTokenAccount:x,userData:N,deposit:E,config:d,vault:f,tokenProgram:le,systemProgram:ne.programId,associatedTokenProgram:ie}).transaction(),{blockhash:D,lastValidBlockHeight:K}=await m.getLatestBlockhash("finalized");M.recentBlockhash=D,M.lastValidBlockHeight=K,M.feePayer=i.publicKey;const G=await i.signTransaction(M),R=await m.sendRawTransaction(G.serialize());await m.confirmTransaction({blockhash:D,lastValidBlockHeight:K,signature:R}),h(a.tokenMint,{isLoading:!1,txSig:R}),S(A=>({...A,[a.tokenMint]:new u(0)}));const Y=await fe(s,t,n);await n.methods.temp(Y).accountsStrict({user:s,userData:N,tokenMint:t}).rpc()}catch(s){console.error("Transaction failed:",s);let t="An unknown error occurred.";s instanceof se?(s.logs||[]).some(f=>f.includes("insufficient funds"))?t="Transaction failed due to insufficient funds. Please check your token balance.":t="Transaction simulation failed. See console for details.":s instanceof Error&&(t=s.message),h(a.tokenMint,{isLoading:!1,error:t})}},U=(a,n)=>{const r=Ne(n);r!==null&&S(s=>({...s,[a]:r})),h(a,{error:null})};l.useEffect(()=>{console.log("Configs changed, loading metadata for:",o.map(n=>{var r;return{mint:n.tokenMint,name:((r=c[n.tokenMint])==null?void 0:r.name)||"Not loaded"}}));const a=async()=>{const n={},r=o.filter(s=>!c[s.tokenMint]);console.log(`Fetching metadata for ${r.length} tokens:`,r.map(s=>s.tokenMint.slice(0,4)+"..."+s.tokenMint.slice(-4)));try{(await Promise.allSettled(r.map(t=>ye(t.tokenMint).then(d=>({tokenMint:t.tokenMint,metadata:d}))))).forEach(t=>{t.status==="fulfilled"&&t.value.metadata?(console.log(`Fetched metadata for ${t.value.tokenMint}:`,t.value.metadata),n[t.value.tokenMint]=t.value.metadata):t.status==="rejected"&&console.error("Error fetching token metadata:",t.reason)}),Object.keys(n).length>0?(console.log("Updating token metadata map with new entries"),q(t=>({...t,...n}))):console.log("No new token metadata to update")}catch(s){console.error("Error in token metadata loading batch:",s)}};o.length>0&&a()},[o,c]),l.useEffect(()=>{if(!i)return;(async()=>{k(!0);try{const n=await ce(i);p(n);const r=[...new Set(n.map(t=>t.tokenMint))],s={};for(const t of r)try{const d=await xe(t);s[t]=Number(d.toString())}catch(d){console.error(`Error fetching price for token ${t}:`,d),s[t]=0}V(s)}catch(n){console.error("Error loading configs:",n)}finally{k(!1)}})()},[i]);const W={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}};if(!i)return e.jsx("div",{className:"w-full bg-gray-950 text-white min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-gray-900 border-2 border-gray-800 rounded-full flex items-center justify-center mb-4",children:e.jsx(be,{className:"h-8 w-8 text-gray-600"})}),e.jsx("h2",{className:"text-2xl font-bold mb-2 text-white",children:"Connect Wallet"}),e.jsx("p",{className:"text-gray-400",children:"Please connect your wallet to deposit collateral."})]})});const Z=o.length>0?{firstConfig:{mint:o[0].tokenMint,metadata:c[o[0].tokenMint],hasLogo:!!((I=c[o[0].tokenMint])!=null&&I.logoURI)},tokenMetadataCount:Object.keys(c).length}:{noConfigs:!0};return console.log("Render debug info:",Z),e.jsxs("div",{className:"w-full bg-gray-950 text-white min-h-screen",children:[e.jsx("div",{className:"fixed bottom-4 right-4 bg-black/80 p-3 rounded-lg text-xs z-50 max-w-xs",children:e.jsxs("div",{className:"font-mono",children:[e.jsxs("div",{children:["Tokens: ",o.length]}),e.jsxs("div",{children:["Metadata: ",Object.keys(c).length]}),o.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{children:["First token: ",o[0].tokenMint.slice(0,6),"...",o[0].tokenMint.slice(-4)]}),e.jsxs("div",{children:["Name: ",((L=c[o[0].tokenMint])==null?void 0:L.name)||"Loading..."]}),e.jsxs("div",{children:["Has logo: ",(B=c[o[0].tokenMint])!=null&&B.logoURI?"✅":"❌"]})]})]})}),e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 py-12",children:[e.jsxs($.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"mb-12",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-white",children:"Deposit Collateral"}),e.jsx("p",{className:"text-lg text-gray-400 mt-2",children:"Select a token and deposit funds to use as collateral."})]}),g?e.jsx(Se,{}):o.length===0?e.jsx("div",{className:"text-center py-16",children:e.jsx("p",{className:"text-gray-400",children:"No token configurations found."})}):e.jsx($.div,{className:"space-y-6",variants:W,initial:"hidden",animate:"visible",children:o.map(a=>{var t,d,f;const n=z(a.tokenMint),r=w[a.tokenMint]||new u(0),s=Ae(r);return e.jsxs(de,{className:"bg-gray-900/50 border-gray-800 overflow-hidden",children:[e.jsx(ue,{children:e.jsxs(me,{className:"text-xl text-white flex items-center gap-3",children:[e.jsxs("div",{className:"relative",style:{width:36,height:36},children:[e.jsx(ke,{mintAddress:a.tokenMint,size:36,className:"border border-purple-500/30"}),!((t=c[a.tokenMint])!=null&&t.logoURI)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-xs font-bold text-white",children:a.tokenMint.slice(0,2).toUpperCase()})]}),e.jsxs("span",{className:"break-all ml-3",children:[((d=c[a.tokenMint])==null?void 0:d.name)||"Token",e.jsxs("span",{className:"text-sm text-gray-400 block mt-1",children:[((f=c[a.tokenMint])==null?void 0:f.symbol)||"TOKEN",P[a.tokenMint]>0&&e.jsxs("span",{className:"ml-2 text-green-400",children:["($",(P[a.tokenMint]/1e4).toFixed(4),")"]})]})]})]})}),e.jsxs(ge,{className:"space-y-4",children:[e.jsx("div",{className:"relative",children:e.jsx(pe,{type:"number",step:"any",min:"0",value:s,placeholder:"0.00",onChange:m=>U(a.tokenMint,m.target.value),disabled:n.isLoading,className:"bg-gray-800 border-gray-700 h-12 text-lg"})}),e.jsx(te,{className:"w-full h-11 text-base bg-purple-600 hover:bg-purple-700 text-white",onClick:()=>F(a),disabled:n.isLoading||r.isZero(),children:n.isLoading?e.jsx(we,{className:"h-5 w-5 animate-spin"}):"Deposit Collateral"}),n.txSig&&e.jsxs("div",{className:"bg-green-900/30 text-green-400 text-sm p-3 border border-green-800 rounded-md flex items-start gap-2",children:[e.jsx(oe,{className:"h-4 w-4 mt-0.5 flex-shrink-0"}),e.jsx("div",{className:"flex-grow min-w-0",children:e.jsxs("a",{href:`https://explorer.solana.com/tx/${n.txSig}?cluster=devnet`,target:"_blank",rel:"noreferrer",className:"text-green-400 hover:text-green-300 underline flex items-center",children:["View Transaction ",e.jsx(ve,{className:"h-3 w-3 ml-1"})]})})]})]})]},a.publicKey)})})]})]})}export{_e as default};
